use strict;
use Test::More 'no_plan';
use Bio::Phylo::Models::Substitution::Dna;
use Bio::Phylo::Matrices::Matrix;
use Bio::Phylo::IO qw(parse_tree);
use Bio::AlignIO;
require_ok('Bio::Phylo::Models::Substitution::Dna');
my $model = Bio::Phylo::Models::Substitution::Dna->new(
    '-type'   => 'GTR',
    '-pi'     => [ 0.23, 0.27, 0.24, 0.26 ],
    '-kappa'  => 2,
    '-alpha'  => 0.9,
    '-pinvar' => 0.5,
    '-ncat'   => 6,
    '-median' => 1,
    '-rate'   => [
        [ 0.23, 0.23, 0.23, 0.23 ],
        [ 0.23, 0.26, 0.26, 0.26 ],
        [ 0.27, 0.26, 0.26, 0.26 ],
        [ 0.24, 0.26, 0.26, 0.26 ]
    ]
);
is( $model->get_alpha, 0.9 );
is( $model->get_kappa, 2 );
ok( $model->get_median );
is( $model->get_ncat,   6 );
is( $model->get_pinvar, 0.5 );
ok( $model->to_string( '-format' => 'garli' ) );

# test modeltest
my $fastastr = << 'FASTA'
>9690
CATGAGCTTTTGGTATTTTTCCAGTGTCTTTGTTCTAAATTCTGAAATTTTGTTTCAAGTATTTTTAATTGCATTGTTCTCAGAATTGCTTGAAGAGAAAAAAAAAATGAGTTGTGAAATATGTACTCTACCTGAGAATTGTTCGTAAGACAGTCACTAGTGAAATGTTAAATTTCCAAATTATTTTCCATAATACTCTTTCTTTAGCAGTCTAAAATGTTGGCCTACATATTCCATAAGTTTTGTGGGGTTTTTTTGTACTAAAATTTGAAGCACAGAAAAGTCAGGTAATCATTCAGAACTAAGGAAATTGGCCTTAATGGAGACAGTAAGGAGCACATCATTGAGCAG
>29064
CATGAGCTTTTGGTATTTTTCCAGTGTCTTTGTTCTAAATTCTGAAATTTTGTTTCAAGTATTTTTAATTGCATTGTTCTCAGAATTGCTTGAAGAGAAAAAAAAAATGAGTTGTGAAATATGTACTCTACCTGAGAATTGTTCGTAAGACAGTCACTAGTGAAATGTTAAATTTCCAAATTATTTTCCATAATACTCTTTCTTTAGCAGTCTAAAATGTTGGCCTACATATTCCATAAGTTTTGTGGGGTTTTTTTGTACTAAAATTTGAAGCACAGAAAAGTCAGGTAATCATTCAGAACTAAGGAAATTGGCCTTAATGGAGACAGTAAGGAGCACATCATTGAGCAG
>9694
CATGAGCTTTTGGTATTTTTCCAGTGTCTTTGTTCTAAATTCTGAAATTTTGTTTCAAGTATTTTTAATTGCATTGTTCTCAGAATTGCTTGAAGAGAAAAAAAAAATGAGTTGTGAAATATGTACTCTACCTGAGAATTGTTCGTAAGACAGTCACTAGTGAAATGTTAAATTTCCAAATTATTTTCCATAATACTCTTTCTTTAGCAGTCTAAAATGTTGGCCTACATATTCCATAAGTTTTGTGGGGTTTTTTTGTACTAAAATTTGAAGCACAGAAAAGTCAGGTAATCATTCAGAACTAAGGAAATTGGCCTTAATGGAGACAGTAAGGAGCACATCATTGAGCAG
>9691
CATGAGCTTTTGGTATTTTTCCAGTGTCTTTGTTCTAAATTCTGAAATTTTGTTTCAAGTATTTTTAATTGCATTGTTCTCAGAATTGCTTGAAGAGAAAAAAAAAATGAGTTGTGAAATATGTACTCTACCTGAGAATTGTTCGTAAGACAGTCACTAGTGAAATGTTAAATTTCCAAATTATTTTCCATAATACTCTTTCTTTAGCAGTCTAAAATGTTGGCCTACATATTCCATAAGTTTTGTGGGGTTTTTTTGTACTAAAATTTGAAGCACAGAAAAGTCAGGTAATCATTCAGAACTAAGGAAATTGGCCTTAATGGAGACAGTAAGGAGCACATCATTGAGCAG
FASTA
;

my $newick = << 'NEWICK'
(((61394:0.026529,61412:0.024045):0.029924,(((61376:0.027806,(427616:0.007206,61452:0.006403):0.019284):
0.004938,61378:0.021599):0.072517,61387:0.034333):0.016844):0.004777,(((((46842:0.046559,((339609:0.077901,
(71111:0.197534,339614:0.062813):0.023736):0.045381,61388:0.039587):0.007007):0.004571,
(((61455:0.045099,61454:0.022032):0.013633,((61383:0.033549,61384:0.033670):0.016087,((61402:0.054203,
(9691:0.016299,339612:0.037517):0.018624):0.011996,61410:0.030455):0.002569):0.001614):0.001031,61408:0.066986):
0.003614):0.006440,(29064:0.036669,(9690:0.045790,9694:0.044743):0.005749):0.031144):0.039766,
(32536:0.105164,32538:0.033228):0.066086):0.005613,61405:0.042446):0.000000):0.000000;
NEWICK
;

my $fasta = Bio::AlignIO->new(
    -string      => $fastastr,
    -format    => 'fasta',
);

my $matrix = Bio::Phylo::Matrices::Matrix->new_from_bioperl( $fasta->next_aln() );

my $tree = parse_tree(
        '-format' => 'newick',
        '-string'   => $newick,
)->resolve;


ok(my $class = 'Bio::Phylo::Models::Substitution::Dna');
my $est = $class->modeltest($matrix, $tree);
isa_ok ( $est,  'Bio::Phylo::Models::Substitution::Dna');

# test modeltest without tree
$est = $class->modeltest($matrix);
isa_ok ( $est,  'Bio::Phylo::Models::Substitution::Dna');
ok ( $est->get_rate );
